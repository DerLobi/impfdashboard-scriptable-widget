var vega=function(e,t,n){"use strict";const r=t.toSet(["rule"]),o=t.toSet(["group","image","rect"]);function a(e){return(e+"").toLowerCase()}function s(e,t,n){";"!==n[n.length-1]&&(n="return("+n+");");const r=Function(...t.concat(n));return e&&e.functions?r.bind(e.functions):r}var c={operator:(e,t)=>s(e,["_"],t.code),parameter:(e,t)=>s(e,["datum","_"],t.code),event:(e,t)=>s(e,["event"],t.code),handler:(e,t)=>s(e,["_","event"],"var datum=event.item&&event.item.datum;return ".concat(t.code,";")),encode:(e,n)=>{const{marktype:a,channels:c}=n;let i="var o=item,datum=o.datum,m=0,$;";for(const e in c){const n="o["+t.stringValue(e)+"]";i+="$=".concat(c[e].code,";if(").concat(n,"!==$)").concat(n,"=$,m=1;")}return i+=function(e,t){let n="";return r[t]||(e.x2&&(e.x?(o[t]&&(n+="if(o.x>o.x2)$=o.x,o.x=o.x2,o.x2=$;"),n+="o.width=o.x2-o.x;"):n+="o.x=o.x2-(o.width||0);"),e.xc&&(n+="o.x=o.xc-(o.width||0)/2;"),e.y2&&(e.y?(o[t]&&(n+="if(o.y>o.y2)$=o.y,o.y=o.y2,o.y2=$;"),n+="o.height=o.y2-o.y;"):n+="o.y=o.y2-(o.height||0);"),e.yc&&(n+="o.y=o.yc-(o.height||0)/2;")),n}(c,a),i+="return m;",s(e,["item","_"],i)},codegen:{get(e){const n="[".concat(e.map(t.stringValue).join("]["),"]"),r=Function("_","return _".concat(n,";"));return r.path=n,r},comparator(e,t){let n;const r=Function("a","b","var u, v; return "+e.map((e,r)=>{const o=t[r];let a,s;return e.path?(a="a".concat(e.path),s="b".concat(e.path)):((n=n||{})["f"+r]=e,a="this.f".concat(r,"(a)"),s="this.f".concat(r,"(b)")),function(e,t,n,r){return"((u = ".concat(e,") < (v = ").concat(t,") || u == null) && v != null ? ").concat(n,"\n  : (u > v || v == null) && u != null ? ").concat(r,"\n  : ((v = v instanceof Date ? +v : v), (u = u instanceof Date ? +u : u)) !== u && v === v ? ").concat(n,"\n  : v !== v && u === u ? ").concat(r," : ")}(a,s,-o,o)}).join("")+"0;");return n?r.bind(n):r}}};function i(e,n,r){if(!e||!t.isObject(e))return e;for(let o,a=0,s=u.length;a<s;++a)if(o=u[a],t.hasOwnProperty(e,o.key))return o.parse(e,n,r);return e}var u=[{key:"$ref",parse:function(e,n){return n.get(e.$ref)||t.error("Operator not defined: "+e.$ref)}},{key:"$key",parse:function(e,n){const r="k:"+e.$key+"_"+!!e.$flat;return n.fn[r]||(n.fn[r]=t.key(e.$key,e.$flat,n.expr.codegen))}},{key:"$expr",parse:function(e,n,r){e.$params&&n.parseParameters(e.$params,r);const o="e:"+e.$expr.code+"_"+e.$name;return n.fn[o]||(n.fn[o]=t.accessor(n.parameterExpression(e.$expr),e.$fields,e.$name))}},{key:"$field",parse:function(e,n){if(!e.$field)return null;const r="f:"+e.$field+"_"+e.$name;return n.fn[r]||(n.fn[r]=t.field(e.$field,e.$name,n.expr.codegen))}},{key:"$encode",parse:function(e,n){const r=e.$encode,o={};for(const e in r){const a=r[e];o[e]=t.accessor(n.encodeExpression(a.$expr),a.$fields),o[e].output=a.$output}return o}},{key:"$compare",parse:function(e,r){const o="c:"+e.$compare+"_"+e.$order,a=t.array(e.$compare).map(e=>e&&e.$tupleid?n.tupleid:e);return r.fn[o]||(r.fn[o]=t.compare(a,e.$order,r.expr.codegen))}},{key:"$context",parse:function(e,t){return t}},{key:"$subflow",parse:function(e,t){const n=e.$subflow;return function(e,r,o){const a=t.fork().parse(n),s=a.get(n.operators[0].id),c=a.signals.parent;return c&&c.set(o),s.detachSubflow=()=>t.detach(a),s}}},{key:"$tupleid",parse:function(){return n.tupleid}}];const p={skip:!0};function d(e,t,n,r){this.dataflow=e,this.transforms=t,this.events=e.events.bind(e),this.expr=r||c,this.signals={},this.scales={},this.nodes={},this.data={},this.fn={},n&&(this.functions=Object.create(n),this.functions.context=this)}function f(e){this.dataflow=e.dataflow,this.transforms=e.transforms,this.events=e.events,this.expr=e.expr,this.signals=Object.create(e.signals),this.scales=Object.create(e.scales),this.nodes=Object.create(e.nodes),this.data=Object.create(e.data),this.fn=Object.create(e.fn),e.functions&&(this.functions=Object.create(e.functions),this.functions.context=this)}return d.prototype=f.prototype={fork(){const e=new f(this);return(this.subcontext||(this.subcontext=[])).push(e),e},detach(e){this.subcontext=this.subcontext.filter(t=>t!==e);const t=Object.keys(e.nodes);for(const n of t)e.nodes[n]._targets=null;for(const n of t)e.nodes[n].detach();e.nodes=null},get(e){return this.nodes[e]},set(e,t){return this.nodes[e]=t},add(e,t){const n=this,r=n.dataflow,o=e.value;if(n.set(e.id,t),"collect"===a(e.type)&&o&&(o.$ingest?r.ingest(t,o.$ingest,o.$format):o.$request?r.preload(t,o.$request,o.$format):r.pulse(t,r.changeset().insert(o))),e.root&&(n.root=t),e.parent){let o=n.get(e.parent.$ref);o?(r.connect(o,[t]),t.targets().add(o)):(n.unresolved=n.unresolved||[]).push(()=>{o=n.get(e.parent.$ref),r.connect(o,[t]),t.targets().add(o)})}if(e.signal&&(n.signals[e.signal]=t),e.scale&&(n.scales[e.scale]=t),e.data)for(const r in e.data){const o=n.data[r]||(n.data[r]={});e.data[r].forEach(e=>o[e]=t)}},resolve(){return(this.unresolved||[]).forEach(e=>e()),delete this.unresolved,this},operator(e,t){this.add(e,this.dataflow.add(e.value,t))},transform(e,t){this.add(e,this.dataflow.add(this.transforms[a(t)]))},stream(e,t){this.set(e.id,t)},update(e,t,n,r,o){this.dataflow.on(t,n,r,o,e.options)},operatorExpression(e){return this.expr.operator(this,e)},parameterExpression(e){return this.expr.parameter(this,e)},eventExpression(e){return this.expr.event(this,e)},handlerExpression(e){return this.expr.handler(this,e)},encodeExpression(e){return this.expr.encode(this,e)},parse:function(e){const t=this,n=e.operators||[];return e.background&&(t.background=e.background),e.eventConfig&&(t.eventConfig=e.eventConfig),e.locale&&(t.locale=e.locale),n.forEach(e=>t.parseOperator(e)),n.forEach(e=>t.parseOperatorParameters(e)),(e.streams||[]).forEach(e=>t.parseStream(e)),(e.updates||[]).forEach(e=>t.parseUpdate(e)),t.resolve()},parseOperator:function(e){const t=this;"operator"!==a(e.type)&&e.type?t.transform(e,e.type):t.operator(e,e.update?t.operatorExpression(e.update):null)},parseOperatorParameters:function(e){const n=this;if(e.params){const r=n.get(e.id);r||t.error("Invalid operator id: "+e.id),n.dataflow.connect(r,r.parameters(n.parseParameters(e.params),e.react,e.initonly))}},parseParameters:function(e,n){n=n||{};const r=this;for(const o in e){const a=e[o];n[o]=t.isArray(a)?a.map(e=>i(e,r,n)):i(a,r,n)}return n},parseStream:function(e){var n,r=this,o=null!=e.filter?r.eventExpression(e.filter):void 0,a=null!=e.stream?r.get(e.stream):void 0;e.source?a=r.events(e.source,e.type,o):e.merge&&(a=(n=e.merge.map(e=>r.get(e)))[0].merge.apply(n[0],n.slice(1))),e.between&&(n=e.between.map(e=>r.get(e)),a=a.between(n[0],n[1])),e.filter&&(a=a.filter(o)),null!=e.throttle&&(a=a.throttle(+e.throttle)),null!=e.debounce&&(a=a.debounce(+e.debounce)),null==a&&t.error("Invalid stream definition: "+JSON.stringify(e)),e.consume&&a.consume(!0),r.stream(e,a)},parseUpdate:function(e){var n,r=this,o=t.isObject(o=e.source)?o.$ref:o,a=r.get(o),s=e.update,c=void 0;a||t.error("Source not defined: "+e.source),n=e.target&&e.target.$expr?r.eventExpression(e.target.$expr):r.get(e.target),s&&s.$expr&&(s.$params&&(c=r.parseParameters(s.$params)),s=r.handlerExpression(s.$expr)),r.update(e,a,n,s,c)},getState:function(e){var t=this,n={};if(e.signals){var r=n.signals={};Object.keys(t.signals).forEach(n=>{const o=t.signals[n];e.signals(n,o)&&(r[n]=o.value)})}if(e.data){var o=n.data={};Object.keys(t.data).forEach(n=>{const r=t.data[n];e.data(n,r)&&(o[n]=r.input.value)})}return t.subcontext&&!1!==e.recurse&&(n.subcontext=t.subcontext.map(t=>t.getState(e))),n},setState:function(e){var n=this,r=n.dataflow,o=e.data,a=e.signals;Object.keys(a||{}).forEach(e=>{r.update(n.signals[e],a[e],p)}),Object.keys(o||{}).forEach(e=>{r.pulse(n.data[e].input,r.changeset().remove(t.truthy).insert(o[e]))}),(e.subcontext||[]).forEach((e,t)=>{const r=n.subcontext[t];r&&r.setState(e)})}},e.context=function(e,t,n,r){return new d(e,t,n,r)},e}({},vega,vega);
//# sourceMappingURL=vega-runtime.min.js.map
