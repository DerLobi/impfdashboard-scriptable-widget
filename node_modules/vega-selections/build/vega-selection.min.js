!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("vega-util"),require("vega-expression")):"function"==typeof define&&define.amd?define(["exports","vega-util","vega-expression"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).vega={},e.vega,e.vega)}(this,(function(e,t,n){"use strict";const r="intersect",i="union",u="index:unit";function l(e,n){for(var r,i,u=n.fields,l=n.values,o=u.length,f=0;f<o;++f)if((i=u[f]).getter=t.field.getter||t.field(i.field),r=i.getter(e),t.isDate(r)&&(r=t.toNumber(r)),t.isDate(l[f])&&(l[f]=t.toNumber(l[f])),t.isDate(l[f][0])&&(l[f]=l[f].map(t.toNumber)),"E"===i.type){if(t.isArray(l[f])?l[f].indexOf(r)<0:r!==l[f])return!1}else if("R"===i.type){if(!t.inrange(r,l[f]))return!1}else if("R-RE"===i.type){if(!t.inrange(r,l[f],!0,!1))return!1}else if("R-E"===i.type){if(!t.inrange(r,l[f],!1,!1))return!1}else if("R-LE"===i.type&&!t.inrange(r,l[f],!1,!0))return!1;return!0}const o=t.field("_vgsid_"),f=function(e){let t=e,n=e;function r(e,t,r,i){for(null==r&&(r=0),null==i&&(i=e.length);r<i;){const u=r+i>>>1;n(e[u],t)<0?r=u+1:i=u}return r}return 1===e.length&&(t=(t,n)=>e(t)-n,n=function(e){return(t,n)=>{return(r=e(t))<(i=n)?-1:r>i?1:r>=i?0:NaN;var r,i}}(e)),{left:r,center:function(e,n,i,u){null==i&&(i=0),null==u&&(u=e.length);const l=r(e,n,i,u-1);return l>i&&t(e[l-1],n)>-t(e[l],n)?l-1:l},right:function(e,t,r,i){for(null==r&&(r=0),null==i&&(i=e.length);r<i;){const u=r+i>>>1;n(e[u],t)>0?i=u:r=u+1}return r}}}(o),s=f.left,a=f.right;var c={E_union:function(e,t){if(!e.length)return t;for(var n=0,r=t.length;n<r;++n)e.indexOf(t[n])<0&&e.push(t[n]);return e},E_intersect:function(e,t){return e.length?e.filter((e=>t.indexOf(e)>=0)):t},R_union:function(e,n){var r=t.toNumber(n[0]),i=t.toNumber(n[1]);return r>i&&(r=n[1],i=n[0]),e.length?(e[0]>r&&(e[0]=r),e[1]<i&&(e[1]=i),e):[r,i]},R_intersect:function(e,n){var r=t.toNumber(n[0]),i=t.toNumber(n[1]);return r>i&&(r=n[1],i=n[0]),e.length?i<e[0]||e[1]<r?[]:(e[0]<r&&(e[0]=r),e[1]>i&&(e[1]=i),e):[r,i]}};e.selectionIdTest=function(e,t,n){const i=this.context.data[e],l=i?i.values.value:[],f=i?i[u]&&i[u].value:void 0,c=n===r,d=o(t),g=s(l,d);if(g===l.length)return!1;if(o(l[g])!==d)return!1;if(f&&c){if(1===f.size)return!0;if(a(l,d)-g<f.size)return!1}return!0},e.selectionResolve=function(e,n,r,u){for(var l,o,f,s,a,d,g,v,h,p,y,m=this.context.data[e],b=m?m.values.value:[],x={},R={},_={},N=b.length,O=0;O<N;++O){for(s=(l=b[O]).unit,o=l.fields,f=l.values,p=0,y=o.length;p<y;++p)a=o[p],g=(d=x[a.field]||(x[a.field]={}))[s]||(d[s]=[]),_[a.field]=v=a.type.charAt(0),h=c[v+"_union"],d[s]=h(g,t.array(f[p]));r&&(g=R[s]||(R[s]=[])).push(t.array(f).reduce(((e,t,n)=>(e[o[n].field]=t,e)),{}))}if(n=n||i,Object.keys(x).forEach((e=>{x[e]=Object.keys(x[e]).map((t=>x[e][t])).reduce(((t,r)=>void 0===t?r:c[_[e]+"_"+n](t,r)))})),b=Object.keys(R),r&&b.length){x[u?"vlPoint":"vlMulti"]=n===i?{or:b.reduce(((e,t)=>(e.push(...R[t]),e)),[])}:{and:b.map((e=>({or:R[e]})))}}return x},e.selectionTest=function(e,t,n){for(var i,o,f,s,a,c=this.context.data[e],d=c?c.values.value:[],g=c?c[u]&&c[u].value:void 0,v=n===r,h=d.length,p=0;p<h;++p)if(i=d[p],g&&v){if(-1===(f=(o=o||{})[s=i.unit]||0))continue;if(a=l(t,i),o[s]=a?-1:++f,a&&1===g.size)return!0;if(!a&&f===g.get(s).count)return!1}else if(v^(a=l(t,i)))return a;return h&&v},e.selectionTuples=function(e,n){return e.map((e=>t.extend({values:n.fields.map((n=>(n.getter||(n.getter=t.field(n.field)))(e.datum)))},n)))},e.selectionVisitor=function(e,i,u,l){i[0].type!==n.Literal&&t.error("First argument to selection functions must be a string literal.");const o=i[0].value,f="unit",s="@unit",a=":"+o;(i.length>=2&&t.peek(i).value)!==r||t.hasOwnProperty(l,s)||(l["@unit"]=u.getData(o).indataRef(u,f)),t.hasOwnProperty(l,a)||(l[a]=u.getData(o).tuplesRef())},Object.defineProperty(e,"__esModule",{value:!0})}));
//# sourceMappingURL=vega-selection.min.js.map
